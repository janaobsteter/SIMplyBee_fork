---
title: "SIMplyBee - quantitative genetics"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{SIMplyBee - quantitative genetics}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  include = TRUE
)
```

# Introduction

This vignette describes and demonstrates how SIMplyBee implements quantitative
genetics principles for honeybees. Specifically, it describes four different
examples where we simulate:

  1. Honey yield - a single colony trait,
  
  2. Honey yield and Calmness - two colony traits,
  
  3. Colony strength and Honey yield - two colony traits where one trait impacts
     the other one via the number of workers, and
  
  4. Swarming and Honey yield - two colony traits where one trait impacts the
     other one via a colony event (swarming).

```{r load packages}
library(package = "SIMplyBee")
library(package = "ggplot2")
```

```{r founderGenomes}
# Founder genomes
founderGenomes <- quickHaplo(nInd = 20, nChr = 16, segSites = 1000)
```

# Honey yield 

```{r SimParamBee}
# Global simulation parameters
SP <- SimParamBee$new(founderGenomes)

# Quantitative genetic parameters - for a single trait with queen and worker genetic effects
meanP <- c(20, 0)
varA <- c(1, 1 / SP$nWorkers)
corA <- matrix(data = c( 1.0, -0.5, 
                        -0.5,  1.0), nrow = 2, byrow = TRUE)
SP$addTraitA(nQtlPerChr = 100, mean = meanP, var = varA, corA = corA)

varE <- c(3, 3 / SP$nWorkers)
# TODO: what is a reasonable environmental correlation between queen and worker effects?
corE <- matrix(data = c( 1.0, -0.3, 
                        -0.3,  1.0), nrow = 2, byrow = TRUE)
SP$setVarE(varE = varE)
SP$setCorE(corE = corE)
```

```{r basePop virgin queens}
# Base population virgin queens
basePop <- createVirginQueens(founderGenomes)
head(basePop@gv)
hist(basePop@pheno[, 1])
hist(basePop@pheno[, 2])
```

TODO: Mention that drones also get these values - they just don't express them

```{r basePop drones}
# Base population drones
drones <- createDrones(x = basePop[1:5], nInd = 5)
head(drones@pheno)
```

```{r create colony}
# Colony
queen <- crossVirginQueen(pop = basePop[6], drones = drones, nFathers = 5)
colony <- createColony(x = queen)
colony
colony@queen@pheno
```

```{r build up colony}
# Check if colony is productive
isProductive(colony)

# Build up colony to reach productive stage
colony <- buildUpColony(colony)
isProductive(colony)
```

```{r queen and workers values}
head(colony@workers@pheno)
```

```{r data.frame}
# Collate genetic and phenotype values
df <- data.frame(id = colony@workers@id,
                 father = colony@workers@father,
                 gvQueenEff = colony@workers@gv[, 1],
                 gvWorkerEff = colony@workers@gv[, 2],
                 pvQueenEff =  colony@workers@pheno[, 1],
                 pvWorkerEff = colony@workers@pheno[, 2])
```

```{r plot queen vs worker values}
# Covariation between queen and worker effects in workers
p <- ggplot(data = df, aes(x = gvQueenEff, y = gvWorkerEff)) +
  geom_point() +
  theme_classic()
print(p)
```

```{r distribution by patriline}
# Variation in worker genetic values by patriline - for queen effects
p <- ggplot(data = df, aes(x = gvQueenEff, colour = father)) +
  geom_density() +
  theme_classic()
print(p)
```

```{r distribution by patriline II}
# Variation in worker genetic values by patriline - for worker effects
p <- ggplot(df, aes(x = gvWorkerEff, colour = father)) +
  geom_density() +
  theme_classic()
print(p)
```

```{r fathers values}
# Variation in patriline genetic values
getFathers(colony)@gv
```

```{r colony pheno} 
# Colony phenotype value
help(phenoQueenPlusSumOfWorkers)
colony <- setPhenoColony(colony, colonyFUN = phenoQueenPlusSumOfWorkers)
colony@pheno
```

# Honey yield and Calmness

```{r SimParamBee II}
# Global simulation parameters
SP <- SimParamBee$new(founderGenomes)

# Quantitative genetic parameters - for two traits with queen and worker genetic effects
# TODO: what is the scale of calmness "values"?
meanP <- c(20, 0, 0, 0)
# TODO: revise covariances (I made them up!)
varA <- c(1, 1 / SP$nWorkers, 1, 1 / SP$nWorkers)
corA <- matrix(data = c( 1.0, -0.5, 0.0, 0.0, 
                        -0.5,  1.0, 0.0, 0.0,
                         0.0,  0.0, 1.0, 0.4,
                         0.0,  0.0, 0.4, 1.0), nrow = 4, byrow = TRUE)
SP$addTraitA(nQtlPerChr = 100, mean = meanP, var = varA, corA = corA)

# TODO: revise covariances (I made them up!)
varE <- c(3, 3 / SP$nWorkers, 3, 3 / SP$nWorkers)
corE <- matrix(data = c( 1.0, -0.3, 0.0, 0.0,
                        -0.3,  1.0, 0.0, 0.0,
                         0.0,  0.0, 1.0, 0.2,
                         0.0,  0.0, 0.2, 1.0), nrow = 4, byrow = TRUE)
SP$setVarE(varE = varE)
SP$setCorE(corE = corE)
```

```{r base pop and colony}
basePop <- createVirginQueens(founderGenomes)
drones <- createDrones(x = basePop[1:5], nInd = 5)
queen <- crossVirginQueen(pop = basePop[6], drones = drones, nFathers = 5)
colony <- createColony(x = queen)
colony <- buildUpColony(colony)
colony
colony@queen@pheno
head(colony@workers@pheno)
```

```{r colony pheno II}
colonyPheno <- function(colony) {
  yield <- phenoQueenPlusSumOfWorkers(colony,
                                      queenTrait = 1,
                                      workersTrait = 2)
  calmness <- phenoQueenPlusSumOfWorkers(colony,
                                         queenTrait = 3,
                                         workersTrait = 4,
                                         checkProduction = FALSE)
  return(cbind(yield, calmness))
}
colony <- setPhenoColony(colony, colonyFUN = colonyPheno)
colony@pheno
```

# Strength and honey yield

Here we will show how to use `nWorkers` function to genetically and
environmentally influence the colony strength and with this honey yield.

```{r SimParamBee III}
# Global simulation parameters
SP <- SimParamBee$new(founderGenomes)

# Quantitative genetic parameters - for two traits with queen and worker genetic effects
meanP <- c(100, 20, 0)
# TODO: revise covariances (I made them up!)
varA <- c(100, 1, 1 / meanP[1]) # meanP[1] will be average nWorkers
corA <- matrix(data = c(1.0,  0.0,  0.0,
                        0.0,  1.0, -0.5, 
                        0.0, -0.5,  1.0), nrow = 3, byrow = TRUE)
SP$addTraitA(nQtlPerChr = 100, mean = meanP, var = varA, corA = corA)

# TODO: revise covariances (I made them up!)
varE <- c(300, 3, 3 / SP$nWorkers)
corE <- matrix(data = c(1.0,  0.0,  0.0,
                        0.0,  1.0, -0.3,
                        0.0, -0.3,  1.0), nrow = 3, byrow = TRUE)
SP$setVarE(varE = varE)
SP$setCorE(corE = corE)
```

```{r base pop and coLony}
basePop <- createVirginQueens(founderGenomes)
drones <- createDrones(x = basePop[1:5], nInd = 5)
queen <- crossVirginQueen(pop = basePop[6], drones = drones, nFathers = 5)
colony <- createColony(x = queen)
colony@queen@pheno
```

```{r colony strength}
# Use already provided function in the package - read about it
help(nWorkersColonyPhenotype)
colony <- buildUpColony(colony, nWorkers = nWorkersColonyPhenotype)
colony
```

```{r colony pheno III}
colonyPheno <- function(colony) {
  yield <- phenoQueenPlusSumOfWorkers(colony,
                                      queenTrait = 2,
                                      workersTrait = 3)
  return(matrix(yield))
}
colony <- setPhenoColony(colony, colonyFUN = colonyPheno)
colony@pheno
```

# Swarming and honey yield

TODO: show how we could genetically and environmentally influence if colony will swarm (can we do this?) and with this honey yield. https://github.com/HighlanderLab/SIMplyBee/issues/105

```{r SimParamBee IV}
# TODO
```
